AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'
Resources:
  MyBucket:
    Type: 'AWS::S3::Bucket'

  S3EventProcessorFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: app.lambda_handler  # Lambda関数のハンドラ名を修正
      Runtime: python3.11  # Pythonのランタイムを指定
      CodeUri: hello_world/  # Lambda関数のコードがあるディレクトリ
      Events:
        S3Event:
          Type: S3
          Properties:
            Bucket: !Ref MyBucket  # トリガーするS3バケット
            Events: s3:ObjectCreated:*  # オブジェクトが作成されたときにトリガー

  LambdaExecutionRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service: 'lambda.amazonaws.com'
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: 'S3AccessPolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: 'Allow'
                Action:
                  - 's3:PutObject'
                  - 's3:GetObject'
                Resource: !Sub 'arn:aws:s3:::${MyBucket}/*'
        - PolicyName: 'CloudWatchLogsPolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: 'Allow'
                Action:
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                Resource: 'arn:aws:logs:*:*:*'
